# Dockerize Web Development Template (DWDT)

# =====================================================================
# 1. NETWORKS
# =====================================================================
networks:
  web-app:
    # Explicitly names the network using the COMPOSE_PROJECT_NAME variable
    name: ${COMPOSE_PROJECT_NAME}_app_net

# =====================================================================
# 2. SERVICES
# =====================================================================
services:
  # +----------------------+ #
  # | Container: NginX     | #
  # +----------------------+ #
  webserver:
    networks:
      - web-app
    container_name: nginx
    build:
      context: .
      dockerfile: containers/nginx/Dockerfile
    image: nginx:nginx-stable-alpine
    ports:
      - "80:80"
    volumes:
      - "${PATH_CONFIGS_NGINX}:/etc/nginx/conf.d/default.conf"
      - "${PATH_VOLUMES_LOGS}/nginx:/var/log/nginx"
      - "${PATH_SOURCE_LOCAL}:${PATH_SOURCE_LIVE}"
      # Vendor volume overlay
      - vendor_data:/var/www/html/vendor
      # Node Modules volume overlay
      - node_modules_data:/var/www/html/node_modules
    depends_on:
      - php
      - database

  # +----------------------+ #
  # | Container: PHP       | #
  # +----------------------+ #
  php:
    networks:
      - web-app
    container_name: php
    build:
      context: .
      dockerfile: containers/php/Dockerfile
    image: php:php-8.2-fpm-alpine
    ports:
      - "9000:9000"
    volumes:
      - "${PATH_CONFIGS_PHP}:/usr/local/etc/php/php.ini"
      - "${PATH_VOLUMES_LOGS}/php:/var/log/php_errors.log"
      - "${PATH_SOURCE_LOCAL}:${PATH_SOURCE_LIVE}"

  # +----------------------+ #
  # | Container: MySQL     | #
  # +----------------------+ #
  database:
    networks:
      - web-app
    container_name: mysql
    build:
      context: .
      dockerfile: containers/mysql/Dockerfile
    image: mysql:mysql-${DB_VERSION}
    # Uncomment the next line for mysql version 7+ to enable native auth mysql -u -p
    # command: mysqld --default-authentication-plugin=mysql_native_password
    restart: unless-stopped
    tty: true
    ports:
      - "3306:3306"
    env_file:
      - "${PATH_ENVIRONMENTS}/${SYS_ENV}.env"
    volumes:
      - "${PATH_VOLUMES_DATABASE}:/var/lib/mysql"
    environment:
      SERVICE_TAGS: dev
      SERVICE_NAME: mysql
# ---- Database Credentials ----
#      MYSQL_DATABASE: "${DB_NAME}"
#      MYSQL_USER: "${DB_USERNAME}"
#      MYSQL_PASSWORD: "${DB_PASSWORD}"
#      MYSQL_ROOT_PASSWORD: "${DB_PASSWORD_ROOT}"

  # +----------------------+ #
  # | Container: Composer  | #
  # +----------------------+ #
  composer:
    networks:
      - web-app
    container_name: composer
    build:
      context: .
      dockerfile: containers/composer/Dockerfile
      # FIX: This crucial block forces the 'php' service to be built first,
      # and makes the resulting image available to the composer Dockerfile
      # under the alias 'base'.
      additional_contexts:
        base: service:php
    image: composer:composer-2.6.1
    working_dir: /var/www/html
    volumes:
      - "${PATH_CONFIGS_PHP}:/usr/local/etc/php/php.ini"
      - "${PATH_SOURCE_LOCAL}:${PATH_SOURCE_LIVE}"
      # CRITICAL: Composer installs dependencies directly into this fast volume
      - vendor_data:/var/www/html/vendor
    depends_on:
      - php
    entrypoint: ['composer']

  # +----------------------+ #
  # | Container: NPM       | #
  # +----------------------+ #
  npm:
    networks:
      - web-app
    container_name: npm
    image: node:20.6-alpine
    working_dir: /var/www/html
    volumes:
      - "${PATH_SOURCE_LOCAL}:${PATH_SOURCE_LIVE}"
      # NEW: Overlays the node_modules directory with a fast Docker volume
      - node_modules_data:/var/www/html/node_modules
    depends_on:
      - php
    entrypoint: ['npm']

#  # +----------------------+ #
#  # | Container: Artisan   | #
#  # +----------------------+ #
#  artisan:
#    networks:
#      - web-app
#    container_name: artisan
#    build:
#      context: .
#      dockerfile: containers/php/Dockerfile
#      # FIX: This crucial block forces the 'php' service to be built first,
#      # and makes the resulting image available to artisan container
#      additional_contexts:
#        base: service:php
#    image: artisan:laravel-XXX # name it with whatever that makes sense for you
#    links:
#      - php
#      - database
#    env_file:
#      - ${PATH_ENVIRONMENTS}/${SYS_ENV}.env
#    working_dir: /var/www/html
#    volumes:
#      - "${PATH_SOURCE_LOCAL}:${PATH_SOURCE_LIVE}"
#      # Must include vendor data so Artisan can execute PHP dependencies
#      - vendor_data:/var/www/html/vendor
#    depends_on:
#      - php
#      - database
#    entrypoint: ['php', '/var/www/html/artisan']

# =====================================================================
# 3. VOLUMES
# =====================================================================
volumes:
  # Dedicated volume for Composer dependencies (vendor folder)
  vendor_data:
    driver: local
  # Dedicated volume for NPM/Node dependencies (node_modules folder)
  node_modules_data:
    driver: local